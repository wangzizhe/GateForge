name: ci

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      run_benchmark:
        description: "Run optional benchmark job"
        required: false
        default: false
        type: boolean
      run_checker_demo:
        description: "Run optional checker-config demo job"
        required: false
        default: false
        type: boolean
      run_steady_state_demo:
        description: "Run optional steady-state checker demo job"
        required: false
        default: false
        type: boolean
      run_behavior_metrics_demo:
        description: "Run optional behavior-metrics checker demo job"
        required: false
        default: false
        type: boolean
      run_demo_bundle:
        description: "Run optional combined demo bundle job"
        required: false
        default: false
        type: boolean
      run_autopilot_dry_run:
        description: "Run optional autopilot dry-run demo job"
        required: false
        default: false
        type: boolean
      run_agent_change_loop:
        description: "Run optional agent change safety loop demo job"
        required: false
        default: false
        type: boolean
      run_repair_loop:
        description: "Run optional repair loop demo job"
        required: false
        default: false
        type: boolean
      run_repair_loop_safety_guard:
        description: "Run optional repair-loop safety guard demo job"
        required: false
        default: false
        type: boolean
      run_planner_guardrails:
        description: "Run optional planner guardrails demo job"
        required: false
        default: false
        type: boolean
      run_planner_output_validate_demo:
        description: "Run optional planner-output validate demo job"
        required: false
        default: false
        type: boolean
      run_repair_batch_demo:
        description: "Run optional repair batch demo job"
        required: false
        default: false
        type: boolean
      run_repair_batch_compare_demo:
        description: "Run optional repair batch profile compare demo job"
        required: false
        default: false
        type: boolean
      run_repair_pack_from_tasks_demo:
        description: "Run optional repair-pack-from-tasks demo job"
        required: false
        default: false
        type: boolean
      run_repair_tasks_demo:
        description: "Run optional repair tasks demo job"
        required: false
        default: false
        type: boolean
      run_repair_orchestrate_demo:
        description: "Run optional repair-orchestrate demo job"
        required: false
        default: false
        type: boolean
      run_repair_orchestrate_compare_demo:
        description: "Run optional repair-orchestrate compare demo job"
        required: false
        default: false
        type: boolean
      run_governance_snapshot_demo:
        description: "Run optional governance snapshot demo job"
        required: false
        default: false
        type: boolean
      run_governance_history_demo:
        description: "Run optional governance history demo job"
        required: false
        default: false
        type: boolean
      run_governance_promote_demo:
        description: "Run optional governance promote decision demo job"
        required: false
        default: false
        type: boolean
      run_governance_promote_compare_demo:
        description: "Run optional governance promote compare demo job"
        required: false
        default: false
        type: boolean
      run_governance_promote_apply_demo:
        description: "Run optional governance promote apply demo job"
        required: false
        default: false
        type: boolean
      run_agent_invariant_guard_demo:
        description: "Run optional agent physical-invariant guard demo job"
        required: false
        default: false
        type: boolean
      run_invariant_repair_loop_demo:
        description: "Run optional invariant repair-loop demo job"
        required: false
        default: false
        type: boolean
      demo_policy_profile:
        description: "Optional policy profile for demo jobs (e.g. industrial_strict_v0)"
        required: false
        default: ""
        type: string

jobs:
  test-and-smoke:
    runs-on: ubuntu-latest
    env:
      GATEFORGE_RUNTIME_THRESHOLD: "0.20"
      GATEFORGE_STRICT_MODEL_SCRIPT: "false"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run tests
        run: python -m unittest discover -s tests -v

      - name: Generate candidate evidence
        run: python -m gateforge.smoke --backend mock --out artifacts/candidate.json

      - name: Run regression gate
        run: |
          EXTRA_FLAGS=""
          if [ "$GATEFORGE_STRICT_MODEL_SCRIPT" = "true" ]; then
            EXTRA_FLAGS="--strict-model-script"
          fi
          python -m gateforge.regress \
            --baseline baselines/mock_baseline.json \
            --candidate artifacts/candidate.json \
            --strict \
            $EXTRA_FLAGS \
            --runtime-threshold "$GATEFORGE_RUNTIME_THRESHOLD" \
            --out artifacts/regression.json

      - name: Upload evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: evidence
          path: |
            baselines/mock_baseline.json
            baselines/mock_baseline.md
            artifacts/candidate.json
            artifacts/candidate.md
            artifacts/regression.json
            artifacts/regression.md

  benchmark-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_benchmark }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run benchmark pack v0
        run: |
          python -m gateforge.benchmark \
            --pack benchmarks/pack_v0.json \
            --out-dir artifacts/benchmark_v0 \
            --summary-out artifacts/benchmark_v0/summary.json \
            --report-out artifacts/benchmark_v0/summary.md

      - name: Upload benchmark artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-v0
          path: |
            artifacts/benchmark_v0

  checker-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_checker_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run checker-config demo
        run: bash scripts/demo_checker_config.sh

      - name: Publish checker demo summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          run_path = Path("artifacts/checker_demo_run.json")
          regress_path = Path("artifacts/checker_demo_regression.json")

          run_payload = json.loads(run_path.read_text(encoding="utf-8")) if run_path.exists() else {}
          reg_payload = json.loads(regress_path.read_text(encoding="utf-8")) if regress_path.exists() else {}

          reasons = reg_payload.get("reasons", []) if isinstance(reg_payload, dict) else []
          findings = reg_payload.get("findings", []) if isinstance(reg_payload, dict) else []

          lines = [
              "## Checker Demo Summary",
              "",
              f"- status: `{run_payload.get('status')}`",
              f"- policy_decision: `{run_payload.get('policy_decision')}`",
              f"- policy_path: `{run_payload.get('policy_path')}`",
              f"- policy_version: `{run_payload.get('policy_version')}`",
              f"- reasons_count: `{len(reasons)}`",
              f"- findings_count: `{len(findings)}`",
              "",
          ]
          text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload checker demo artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checker-config-demo
          path: |
            artifacts/checker_demo_baseline.json
            artifacts/checker_demo_candidate.json
            artifacts/checker_demo_regression.json
            artifacts/checker_demo_regression.md
            artifacts/checker_demo_run.json
            artifacts/checker_demo_run.md
            artifacts/checker_demo_summary.md

  steady-state-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_steady_state_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run steady-state checker demo
        run: bash scripts/demo_steady_state_checker.sh

      - name: Publish steady-state demo summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          regress_path = Path("artifacts/steady_state_demo_regression.json")
          if not regress_path.exists():
              text = "## Steady-State Demo Summary\n\n`artifacts/steady_state_demo_regression.json` not found."
          else:
              payload = json.loads(regress_path.read_text(encoding="utf-8"))
              reasons = payload.get("reasons", []) if isinstance(payload, dict) else []
              findings = payload.get("findings", []) if isinstance(payload, dict) else []
              lines = [
                  "## Steady-State Demo Summary",
                  "",
                  f"- decision: `{payload.get('decision')}`",
                  f"- policy_decision: `{payload.get('policy_decision')}`",
                  f"- policy_path: `{payload.get('policy_path')}`",
                  f"- reasons_count: `{len(reasons)}`",
                  f"- findings_count: `{len(findings)}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload steady-state demo artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: steady-state-demo
          path: |
            artifacts/steady_state_demo_baseline.json
            artifacts/steady_state_demo_candidate.json
            artifacts/steady_state_demo_regression.json
            artifacts/steady_state_demo_regression.md
            artifacts/steady_state_demo_summary.md

  behavior-metrics-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_behavior_metrics_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run behavior-metrics checker demo
        run: bash scripts/demo_behavior_metrics_checker.sh

      - name: Publish behavior-metrics demo summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          regress_path = Path("artifacts/behavior_metrics_demo/regression.json")
          if not regress_path.exists():
              text = "## Behavior Metrics Demo Summary\n\n`artifacts/behavior_metrics_demo/regression.json` not found."
          else:
              payload = json.loads(regress_path.read_text(encoding="utf-8"))
              reasons = payload.get("reasons", []) if isinstance(payload, dict) else []
              findings = payload.get("findings", []) if isinstance(payload, dict) else []
              lines = [
                  "## Behavior Metrics Demo Summary",
                  "",
                  f"- decision: `{payload.get('decision')}`",
                  f"- policy_decision: `{payload.get('policy_decision')}`",
                  f"- policy_path: `{payload.get('policy_path')}`",
                  f"- reasons_count: `{len(reasons)}`",
                  f"- findings_count: `{len(findings)}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload behavior-metrics demo artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behavior-metrics-demo
          path: |
            artifacts/behavior_metrics_demo/baseline.json
            artifacts/behavior_metrics_demo/candidate.json
            artifacts/behavior_metrics_demo/regression.json
            artifacts/behavior_metrics_demo/regression.md
            artifacts/behavior_metrics_demo/summary.json
            artifacts/behavior_metrics_demo/summary.md

  demo-bundle-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_demo_bundle }}
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run demo bundle
        run: bash scripts/demo_all.sh

      - name: Publish demo bundle summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/demo_all_summary.json")
          if not path.exists():
              text = "## Demo Bundle Summary\n\n`artifacts/demo_all_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              rf = payload.get("result_flags", {})
              lines = [
                  "## Demo Bundle Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- policy_profile: `{payload.get('policy_profile')}`",
                  f"- proposal_flow_status: `{payload.get('proposal_flow_status')}`",
                  f"- checker_demo_status: `{payload.get('checker_demo_status')}`",
                  f"- checker_demo_policy_decision: `{payload.get('checker_demo_policy_decision')}`",
                  f"- steady_demo_decision: `{payload.get('steady_demo_decision')}`",
                  f"- behavior_demo_decision: `{payload.get('behavior_demo_decision')}`",
                  f"- proposal_fail_reasons_count: `{payload.get('proposal_fail_reasons_count')}`",
                  f"- checker_reasons_count: `{payload.get('checker_reasons_count')}`",
                  f"- checker_findings_count: `{payload.get('checker_findings_count')}`",
                  f"- steady_reasons_count: `{payload.get('steady_reasons_count')}`",
                  f"- steady_findings_count: `{payload.get('steady_findings_count')}`",
                  f"- behavior_reasons_count: `{payload.get('behavior_reasons_count')}`",
                  f"- behavior_findings_count: `{payload.get('behavior_findings_count')}`",
                  f"- checksums_count: `{len(payload.get('checksums', {}))}`",
                  "",
                  "### Result Flags",
                  "",
                  f"- proposal_flow: `{rf.get('proposal_flow')}`",
                  f"- checker_demo_expected_fail: `{rf.get('checker_demo_expected_fail')}`",
                  f"- steady_demo_expected_nonpass: `{rf.get('steady_demo_expected_nonpass')}`",
                  f"- behavior_demo_expected_nonpass: `{rf.get('behavior_demo_expected_nonpass')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload demo bundle artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-bundle
          path: |
            artifacts/proposal_run_demo.json
            artifacts/proposal_run_demo.md
            artifacts/regression_from_proposal_demo.json
            artifacts/regression_from_proposal_demo.md
            artifacts/checker_demo_baseline.json
            artifacts/checker_demo_candidate.json
            artifacts/checker_demo_regression.json
            artifacts/checker_demo_regression.md
            artifacts/checker_demo_run.json
            artifacts/checker_demo_run.md
            artifacts/checker_demo_summary.md
            artifacts/steady_state_demo_regression.json
            artifacts/steady_state_demo_regression.md
            artifacts/steady_state_demo_summary.md
            artifacts/demo_all_summary.md
            artifacts/demo_all_summary.json

  autopilot-dry-run-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_autopilot_dry_run }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run autopilot dry-run demo
        run: bash scripts/demo_autopilot_dry_run.sh

      - name: Publish dry-run summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/autopilot/autopilot_dry_run_demo.json")
          if not path.exists():
              text = "## Autopilot Dry-Run Summary\n\n`artifacts/autopilot/autopilot_dry_run_demo.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              checks = payload.get("planned_required_human_checks", [])
              lines = [
                  "## Autopilot Dry-Run Summary",
                  "",
                  f"- status: `{payload.get('status')}`",
                  f"- policy_path: `{payload.get('planned_run', {}).get('policy')}`",
                  f"- policy_version: `{payload.get('policy_version')}`",
                  f"- planned_risk_level: `{payload.get('planned_risk_level')}`",
                  f"- planned_required_human_checks_count: `{len(checks)}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload dry-run demo artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-dry-run-demo
          path: |
            artifacts/autopilot/demo_dry_run_context.json
            artifacts/autopilot/autopilot_dry_run_demo.json
            artifacts/autopilot/autopilot_dry_run_demo.md

  agent-change-loop-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_agent_change_loop }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run agent change safety loop demo
        run: bash scripts/demo_agent_change_loop.sh

      - name: Publish agent change loop summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/agent_change_loop/summary.json")
          if not path.exists():
              text = "## Agent Change Loop Summary\n\n`artifacts/agent_change_loop/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              rf = payload.get("result_flags", {})
              lines = [
                  "## Agent Change Loop Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- policy_profile: `{payload.get('policy_profile')}`",
                  f"- low_risk_status: `{payload.get('low_risk_status')}`",
                  f"- high_risk_status: `{payload.get('high_risk_status')}`",
                  f"- high_risk_required_human_checks_count: `{payload.get('high_risk_required_human_checks_count')}`",
                  "",
                  "### Result Flags",
                  "",
                  f"- low_risk_expected_pass: `{rf.get('low_risk_expected_pass')}`",
                  f"- high_risk_expected_needs_review: `{rf.get('high_risk_expected_needs_review')}`",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload agent change loop artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-change-loop-demo
          path: |
            artifacts/agent_change_loop/high_context.json
            artifacts/agent_change_loop/low_summary.json
            artifacts/agent_change_loop/high_summary.json
            artifacts/agent_change_loop/summary.json
            artifacts/agent_change_loop/summary.md

  repair-loop-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_loop }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair loop demo
        run: bash scripts/demo_repair_loop.sh

      - name: Publish repair loop summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_loop/demo_summary.json")
          if not path.exists():
              text = "## Repair Loop Summary\n\n`artifacts/repair_loop/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Loop Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- before_status: `{payload.get('before_status')}`",
                  f"- after_status: `{payload.get('after_status')}`",
                  f"- delta: `{payload.get('delta')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair loop artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-loop-demo
          path: |
            artifacts/repair_loop/summary.json
            artifacts/repair_loop/summary.md
            artifacts/repair_loop/demo_summary.json
            artifacts/repair_loop/demo_summary.md

  repair-loop-safety-guard-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_loop_safety_guard }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair loop safety guard demo
        run: bash scripts/demo_repair_loop_safety_guard.sh

      - name: Publish repair loop safety guard summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_loop_safety_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Loop Safety Guard Summary\n\n`artifacts/repair_loop_safety_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Loop Safety Guard Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- status: `{payload.get('status')}`",
                  f"- after_status: `{payload.get('after_status')}`",
                  f"- safety_guard_triggered: `{payload.get('safety_guard_triggered')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair loop safety guard artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-loop-safety-guard-demo
          path: |
            artifacts/repair_loop_safety_demo/summary.json
            artifacts/repair_loop_safety_demo/summary.md
            artifacts/repair_loop_safety_demo/demo_summary.json
            artifacts/repair_loop_safety_demo/demo_summary.md

  planner-guardrails-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_planner_guardrails }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run planner guardrails demo
        run: bash scripts/demo_planner_guardrails.sh

      - name: Publish planner guardrails summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/planner_guardrails_demo/summary.json")
          if not path.exists():
              text = "## Planner Guardrails Summary\n\n`artifacts/planner_guardrails_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              rule_ids = payload.get("rule_ids", {}).get("all", [])
              lines = [
                  "## Planner Guardrails Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- pass_case_status: `{payload.get('pass_case', {}).get('status')}`",
                  f"- low_confidence_case_status: `{payload.get('low_confidence_case', {}).get('status')}`",
                  f"- whitelist_case_status: `{payload.get('whitelist_case', {}).get('status')}`",
                  f"- rule_ids_count: `{len(rule_ids)}`",
                  f"- rule_ids_all: `{','.join(rule_ids) if rule_ids else 'none'}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload planner guardrails artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: planner-guardrails-demo
          path: |
            artifacts/planner_guardrails_demo/pass_intent.json
            artifacts/planner_guardrails_demo/summary.json
            artifacts/planner_guardrails_demo/summary.md

  planner-output-validate-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_planner_output_validate_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run planner output validate demo
        run: bash scripts/demo_planner_output_validate.sh

      - name: Publish planner output validate summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/planner_output_validate_demo/summary.json")
          if not path.exists():
              text = "## Planner Output Validate Summary\n\n`artifacts/planner_output_validate_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Planner Output Validate Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- pass_case_status: `{payload.get('pass_case_status')}`",
                  f"- fail_case_status: `{payload.get('fail_case_status')}`",
                  f"- fail_case_exit_code: `{payload.get('fail_case_exit_code')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload planner output validate artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: planner-output-validate-demo
          path: |
            artifacts/planner_output_validate_demo/pass_result.json
            artifacts/planner_output_validate_demo/fail_result.json
            artifacts/planner_output_validate_demo/summary.json
            artifacts/planner_output_validate_demo/summary.md

  repair-batch-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_batch_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair batch demo
        run: bash scripts/demo_repair_batch.sh

      - name: Publish repair batch summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_batch_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Batch Summary\n\n`artifacts/repair_batch_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Batch Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- total_cases: `{payload.get('total_cases')}`",
                  f"- pass_count: `{payload.get('pass_count')}`",
                  f"- fail_count: `{payload.get('fail_count')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair batch artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-batch-demo
          path: |
            artifacts/repair_batch_demo/summary.json
            artifacts/repair_batch_demo/summary.md
            artifacts/repair_batch_demo/demo_summary.json
            artifacts/repair_batch_demo/demo_summary.md

  repair-batch-compare-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_batch_compare_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair batch compare demo
        run: bash scripts/demo_repair_batch_compare.sh

      - name: Publish repair batch compare summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_batch_compare_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Batch Compare Summary\n\n`artifacts/repair_batch_compare_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              compare = payload.get("compare", {})
              lines = [
                  "## Repair Batch Compare Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- total_cases: `{payload.get('total_cases')}`",
                  f"- from_policy_profile: `{compare.get('from_policy_profile')}`",
                  f"- to_policy_profile: `{compare.get('to_policy_profile')}`",
                  f"- strict_downgrade_rate: `{compare.get('strict_downgrade_rate')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair batch compare artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-batch-compare-demo
          path: |
            artifacts/repair_batch_compare_demo/summary.json
            artifacts/repair_batch_compare_demo/summary.md
            artifacts/repair_batch_compare_demo/demo_summary.json
            artifacts/repair_batch_compare_demo/demo_summary.md

  repair-tasks-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_tasks_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair tasks demo
        run: bash scripts/demo_repair_tasks.sh

      - name: Publish repair tasks summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_tasks_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Tasks Summary\n\n`artifacts/repair_tasks_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Tasks Summary",
                  "",
                  f"- policy_decision: `{payload.get('policy_decision')}`",
                  f"- task_count: `{payload.get('task_count')}`",
                  f"- p0_count: `{payload.get('p0_count')}`",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair tasks artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-tasks-demo
          path: |
            artifacts/repair_tasks_demo/summary.json
            artifacts/repair_tasks_demo/summary.md
            artifacts/repair_tasks_demo/demo_summary.json
            artifacts/repair_tasks_demo/demo_summary.md

  repair-pack-from-tasks-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_pack_from_tasks_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair pack from tasks demo
        run: bash scripts/demo_repair_pack_from_tasks.sh

      - name: Publish repair pack from tasks summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_pack_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Pack From Tasks Summary\n\n`artifacts/repair_pack_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Pack From Tasks Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- pack_id: `{payload.get('pack_id')}`",
                  f"- case_count: `{payload.get('case_count')}`",
                  f"- strategy_profile: `industrial_strict`",
                  f"- improved_count: `{payload.get('improved_count')}`",
                  f"- safety_block_count: `{payload.get('safety_block_count')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair pack from tasks artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-pack-from-tasks-demo
          path: |
            artifacts/repair_pack_demo/pack.json
            artifacts/repair_pack_demo/summary.json
            artifacts/repair_pack_demo/summary.md
            artifacts/repair_pack_demo/demo_summary.json
            artifacts/repair_pack_demo/demo_summary.md

  repair-orchestrate-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_orchestrate_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair orchestrate demo
        run: bash scripts/demo_repair_orchestrate.sh

      - name: Publish repair orchestrate summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_orchestrate_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Orchestrate Summary\n\n`artifacts/repair_orchestrate_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Orchestrate Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- status: `{payload.get('status')}`",
                  f"- strategy_profile: `{payload.get('strategy_profile')}`",
                  f"- total_cases: `{payload.get('total_cases')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair orchestrate artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-orchestrate-demo
          path: |
            artifacts/repair_orchestrate_demo/summary.json
            artifacts/repair_orchestrate_demo/tasks.json
            artifacts/repair_orchestrate_demo/tasks.md
            artifacts/repair_orchestrate_demo/pack.json
            artifacts/repair_orchestrate_demo/batch_summary.json
            artifacts/repair_orchestrate_demo/batch_summary.md
            artifacts/repair_orchestrate_demo/demo_summary.json
            artifacts/repair_orchestrate_demo/demo_summary.md

  repair-orchestrate-compare-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_repair_orchestrate_compare_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run repair orchestrate compare demo
        run: bash scripts/demo_repair_orchestrate_compare.sh

      - name: Publish repair orchestrate compare summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/repair_orchestrate_compare_demo/demo_summary.json")
          if not path.exists():
              text = "## Repair Orchestrate Compare Summary\n\n`artifacts/repair_orchestrate_compare_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Repair Orchestrate Compare Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- status: `{payload.get('status')}`",
                  f"- primary_batch_status: `{payload.get('primary_batch_status')}`",
                  f"- compare_batch_status: `{payload.get('compare_batch_status')}`",
                  f"- compare_relation: `{payload.get('compare_relation')}`",
                  f"- recommended_profile: `{payload.get('recommended_profile')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload repair orchestrate compare artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-orchestrate-compare-demo
          path: |
            artifacts/repair_orchestrate_compare_demo/summary.json
            artifacts/repair_orchestrate_compare_demo/summary.md
            artifacts/repair_orchestrate_compare_demo/tasks.json
            artifacts/repair_orchestrate_compare_demo/tasks.md
            artifacts/repair_orchestrate_compare_demo/pack.json
            artifacts/repair_orchestrate_compare_demo/batch_summary.json
            artifacts/repair_orchestrate_compare_demo/batch_summary.md
            artifacts/repair_orchestrate_compare_demo/compare_industrial_strict/tasks.json
            artifacts/repair_orchestrate_compare_demo/compare_industrial_strict/tasks.md
            artifacts/repair_orchestrate_compare_demo/compare_industrial_strict/pack.json
            artifacts/repair_orchestrate_compare_demo/compare_industrial_strict/batch_summary.json
            artifacts/repair_orchestrate_compare_demo/compare_industrial_strict/batch_summary.md
            artifacts/repair_orchestrate_compare_demo/demo_summary.json
            artifacts/repair_orchestrate_compare_demo/demo_summary.md

  governance-snapshot-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_snapshot_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance snapshot demo
        run: bash scripts/demo_governance_snapshot.sh

      - name: Publish governance snapshot summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_snapshot_demo/summary.json")
          if not path.exists():
              text = "## Governance Snapshot Summary\n\n`artifacts/governance_snapshot_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              kpis = payload.get("kpis", {})
              lines = [
                  "## Governance Snapshot Summary",
                  "",
                  f"- status: `{payload.get('status')}`",
                  f"- strict_downgrade_rate: `{kpis.get('strict_downgrade_rate')}`",
                  f"- review_recovery_rate: `{kpis.get('review_recovery_rate')}`",
                  f"- strict_non_pass_rate: `{kpis.get('strict_non_pass_rate')}`",
                  f"- risks: `{','.join(payload.get('risks', [])) or 'none'}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance snapshot artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-snapshot-demo
          path: |
            artifacts/governance_snapshot_demo/summary.json
            artifacts/governance_snapshot_demo/summary.md

  governance-snapshot-orchestrate-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_snapshot_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance snapshot from orchestrate compare demo
        run: bash scripts/demo_governance_snapshot_from_orchestrate_compare.sh

      - name: Publish governance snapshot from orchestrate compare summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_snapshot_orchestrate_demo/demo_summary.json")
          if not path.exists():
              text = "## Governance Snapshot (Orchestrate Compare) Summary\n\n`artifacts/governance_snapshot_orchestrate_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Governance Snapshot (Orchestrate Compare) Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- status: `{payload.get('status')}`",
                  f"- strategy_compare_relation: `{payload.get('strategy_compare_relation')}`",
                  f"- recommended_profile: `{payload.get('recommended_profile')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance snapshot from orchestrate compare artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-snapshot-orchestrate-demo
          path: |
            artifacts/governance_snapshot_orchestrate_demo/summary.json
            artifacts/governance_snapshot_orchestrate_demo/summary.md
            artifacts/governance_snapshot_orchestrate_demo/demo_summary.json
            artifacts/governance_snapshot_orchestrate_demo/demo_summary.md
            artifacts/repair_orchestrate_compare_demo/summary.json
            artifacts/repair_orchestrate_compare_demo/demo_summary.json

  governance-snapshot-trend-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_snapshot_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance snapshot trend demo
        run: bash scripts/demo_governance_snapshot_trend.sh

      - name: Publish governance snapshot trend summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_snapshot_trend_demo/summary.json")
          if not path.exists():
              text = "## Governance Snapshot Trend Summary\n\n`artifacts/governance_snapshot_trend_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              trend = payload.get("trend", {})
              lines = [
                  "## Governance Snapshot Trend Summary",
                  "",
                  f"- status: `{payload.get('status')}`",
                  f"- status_transition: `{trend.get('status_transition')}`",
                  f"- new_risks: `{','.join(trend.get('new_risks', [])) or 'none'}`",
                  f"- resolved_risks: `{','.join(trend.get('resolved_risks', [])) or 'none'}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance snapshot trend artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-snapshot-trend-demo
          path: |
            artifacts/governance_snapshot_trend_demo/summary.json
            artifacts/governance_snapshot_trend_demo/summary.md

  governance-history-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_history_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance history demo
        run: bash scripts/demo_governance_history.sh

      - name: Publish governance history summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_history_demo/summary.json")
          if not path.exists():
              text = "## Governance History Summary\n\n`artifacts/governance_history_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              tk = payload.get("transition_kpis", {})
              lines = [
                  "## Governance History Summary",
                  "",
                  f"- total_records: `{payload.get('total_records')}`",
                  f"- window_size: `{payload.get('window_size')}`",
                  f"- latest_status: `{payload.get('latest_status')}`",
                  f"- transition_count: `{tk.get('transition_count')}`",
                  f"- improved_count: `{tk.get('improved_count')}`",
                  f"- worse_count: `{tk.get('worse_count')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance history artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-history-demo
          path: |
            artifacts/governance_history_demo/summary.json
            artifacts/governance_history_demo/summary.md

  governance-promote-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_promote_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance promote demo
        run: bash scripts/demo_governance_promote.sh

      - name: Publish governance promote summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_promote_demo/summary.json")
          if not path.exists():
              text = "## Governance Promote Summary\n\n`artifacts/governance_promote_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Governance Promote Summary",
                  "",
                  f"- default_decision: `{payload.get('default_decision')}`",
                  f"- industrial_decision: `{payload.get('industrial_decision')}`",
                  f"- override_decision: `{payload.get('override_decision')}`",
                  f"- override_applied: `{payload.get('override_applied')}`",
                  f"- industrial_exit_code: `{payload.get('industrial_exit_code')}`",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance promote artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-promote-demo
          path: |
            artifacts/governance_promote_demo/default.json
            artifacts/governance_promote_demo/default.md
            artifacts/governance_promote_demo/industrial.json
            artifacts/governance_promote_demo/industrial.md
            artifacts/governance_promote_demo/override_allow_promote.json
            artifacts/governance_promote_demo/override.json
            artifacts/governance_promote_demo/override.md
            artifacts/governance_promote_demo/summary.json
            artifacts/governance_promote_demo/summary.md

  governance-promote-compare-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_promote_compare_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance promote compare demo
        run: bash scripts/demo_governance_promote_compare.sh

      - name: Publish governance promote compare summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_promote_compare_demo/demo_summary.json")
          if not path.exists():
              text = "## Governance Promote Compare Summary\n\n`artifacts/governance_promote_compare_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Governance Promote Compare Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- status: `{payload.get('status')}`",
                  f"- best_profile: `{payload.get('best_profile')}`",
                  f"- best_decision: `{payload.get('best_decision')}`",
                  f"- best_reason: `{payload.get('best_reason')}`",
                  f"- best_total_score: `{payload.get('best_total_score')}`",
                  f"- top_score_margin: `{payload.get('top_score_margin')}`",
                  f"- min_top_score_margin: `{payload.get('min_top_score_margin')}`",
                  f"- recommended_profile: `{payload.get('recommended_profile')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance promote compare artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-promote-compare-demo
          path: |
            artifacts/governance_promote_compare_demo/default.json
            artifacts/governance_promote_compare_demo/industrial_strict.json
            artifacts/governance_promote_compare_demo/override_map.json
            artifacts/governance_promote_compare_demo/override_allow_industrial.json
            artifacts/governance_promote_compare_demo/summary.json
            artifacts/governance_promote_compare_demo/summary.md
            artifacts/governance_promote_compare_demo/summary_with_override.json
            artifacts/governance_promote_compare_demo/summary_with_override.md
            artifacts/governance_promote_compare_demo/with_override/default.json
            artifacts/governance_promote_compare_demo/with_override/industrial_strict.json
            artifacts/governance_promote_compare_demo/demo_summary.json
            artifacts/governance_promote_compare_demo/demo_summary.md

  governance-promote-apply-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_governance_promote_apply_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    env:
      POLICY_PROFILE: ${{ inputs.demo_policy_profile }}
      PROMOTE_APPLY_REQUIRE_RANKING_EXPLANATION: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run governance promote apply demo
        run: bash scripts/demo_governance_promote_apply.sh

      - name: Publish governance promote apply summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/governance_promote_apply_demo/summary.json")
          if not path.exists():
              text = "## Governance Promote Apply Summary\n\n`artifacts/governance_promote_apply_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Governance Promote Apply Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- require_ranking_explanation: `{payload.get('require_ranking_explanation')}`",
                  f"- pass_status: `{payload.get('pass_status')}`",
                  f"- missing_ticket_status: `{payload.get('missing_ticket_status')}`",
                  f"- with_ticket_status: `{payload.get('with_ticket_status')}`",
                  f"- with_ticket_id: `{payload.get('with_ticket_id')}`",
                  f"- audit_row_count: `{payload.get('audit_row_count')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload governance promote apply artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-promote-apply-demo
          path: |
            artifacts/governance_promote_apply_demo/pass_apply.json
            artifacts/governance_promote_apply_demo/pass_apply.md
            artifacts/governance_promote_apply_demo/synthetic_needs_review_compare.json
            artifacts/governance_promote_apply_demo/review_missing_ticket.json
            artifacts/governance_promote_apply_demo/review_missing_ticket.md
            artifacts/governance_promote_apply_demo/review_with_ticket.json
            artifacts/governance_promote_apply_demo/review_with_ticket.md
            artifacts/governance_promote_apply_demo/decision_audit.jsonl
            artifacts/governance_promote_apply_demo/summary.json
            artifacts/governance_promote_apply_demo/summary.md

  agent-invariant-guard-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_agent_invariant_guard_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run agent invariant guard demo
        run: bash scripts/demo_agent_invariant_guard.sh

      - name: Publish agent invariant guard summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/agent_invariant_guard_demo/summary.json")
          if not path.exists():
              text = "## Agent Invariant Guard Summary\n\n`artifacts/agent_invariant_guard_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Agent Invariant Guard Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- pass_decision: `{payload.get('pass_decision')}`",
                  f"- medium_decision: `{payload.get('medium_decision')}`",
                  f"- high_decision: `{payload.get('high_decision')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload agent invariant guard artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-invariant-guard-demo
          path: |
            artifacts/agent_invariant_guard_demo/proposal_medium.json
            artifacts/agent_invariant_guard_demo/proposal_high.json
            artifacts/agent_invariant_guard_demo/baseline.json
            artifacts/agent_invariant_guard_demo/candidate_pass.json
            artifacts/agent_invariant_guard_demo/candidate_fail.json
            artifacts/agent_invariant_guard_demo/regression_pass.json
            artifacts/agent_invariant_guard_demo/regression_medium_nonpass.json
            artifacts/agent_invariant_guard_demo/regression_high_fail.json
            artifacts/agent_invariant_guard_demo/summary.json
            artifacts/agent_invariant_guard_demo/summary.md

  invariant-repair-loop-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_invariant_repair_loop_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run invariant repair loop demo
        run: bash scripts/demo_invariant_repair_loop.sh

      - name: Publish invariant repair loop summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/invariant_repair_loop_demo/demo_summary.json")
          if not path.exists():
              text = "## Invariant Repair Loop Summary\n\n`artifacts/invariant_repair_loop_demo/demo_summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Invariant Repair Loop Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- plan_detected: `{payload.get('plan_detected')}`",
                  f"- loop_applied: `{payload.get('loop_applied')}`",
                  f"- before_status: `{payload.get('before_status')}`",
                  f"- after_status: `{payload.get('after_status')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload invariant repair loop artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: invariant-repair-loop-demo
          path: |
            artifacts/invariant_repair_loop_demo/source_fail.json
            artifacts/invariant_repair_loop_demo/plan.json
            artifacts/invariant_repair_loop_demo/plan.md
            artifacts/invariant_repair_loop_demo/summary.json
            artifacts/invariant_repair_loop_demo/summary.md
            artifacts/invariant_repair_loop_demo/demo_summary.json
            artifacts/invariant_repair_loop_demo/demo_summary.md

  invariant-repair-profile-compare-demo-optional:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_invariant_repair_loop_demo }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run invariant repair profile compare demo
        run: bash scripts/demo_invariant_repair_profile_compare.sh

      - name: Publish invariant repair profile compare summary to job page
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          path = Path("artifacts/invariant_repair_profile_compare_demo/summary.json")
          if not path.exists():
              text = "## Invariant Repair Profile Compare Summary\n\n`artifacts/invariant_repair_profile_compare_demo/summary.json` not found."
          else:
              payload = json.loads(path.read_text(encoding="utf-8"))
              lines = [
                  "## Invariant Repair Profile Compare Summary",
                  "",
                  f"- bundle_status: `{payload.get('bundle_status')}`",
                  f"- default_status: `{payload.get('default_status')}`",
                  f"- industrial_status: `{payload.get('industrial_status')}`",
                  f"- relation: `{payload.get('relation')}`",
                  f"- default_confidence_min: `{payload.get('default_confidence_min')}`",
                  f"- industrial_confidence_min: `{payload.get('industrial_confidence_min')}`",
                  "",
              ]
              text = "\n".join(lines)

          summary_file = os.getenv("GITHUB_STEP_SUMMARY")
          if summary_file:
              with open(summary_file, "a", encoding="utf-8") as f:
                  f.write(text + "\n")
          print(text)
          PY

      - name: Upload invariant repair profile compare artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: invariant-repair-profile-compare-demo
          path: |
            artifacts/invariant_repair_profile_compare_demo/source_fail.json
            artifacts/invariant_repair_profile_compare_demo/default.json
            artifacts/invariant_repair_profile_compare_demo/industrial.json
            artifacts/invariant_repair_profile_compare_demo/summary.json
            artifacts/invariant_repair_profile_compare_demo/summary.md
